# 更新操作

本指南详细介绍如何在 jorm 中更新数据库中的数据。

## 基础更新

### 更新单条记录

使用 `Update()` 方法更新记录：

```go
affected, err := db.Model(&User{}).
    Where("id = ?", 1).
    Update(map[string]any{
        "name": "Alice Updated",
        "age":  26,
    })
if err != nil {
    panic(err)
}

fmt.Printf("更新了 %d 条记录\n", affected)
```

### 使用结构体更新

```go
user := &User{
    Name: "Alice",
    Age:  26,
}

affected, err := db.Model(&User{}).
    Where("id = ?", 1).
    Update(user)
if err != nil {
    panic(err)
}
```

## 批量更新

### 更新多条记录

```go
// 将所有状态为 'pending' 的用户改为 'active'
affected, err := db.Model(&User{}).
    Where("status = ?", "pending").
    Update(map[string]any{
        "status": "active",
    })
if err != nil {
    panic(err)
}

fmt.Printf("更新了 %d 条记录\n", affected)
```

### 条件批量更新

```go
// 更新年龄大于 18 的用户状态
affected, err := db.Model(&User{}).
    Where("age > ?", 18).
    Where("status = ?", "inactive").
    Update(map[string]any{
        "status": "active",
    })
```

## 字段更新

### 更新单个字段

```go
// 更新单个字段
affected, err := db.Model(&User{}).
    Where("id = ?", 1).
    Update(map[string]any{
        "age": 26,
    })
```

### 更新多个字段

```go
// 更新多个字段
affected, err := db.Model(&User{}).
    Where("id = ?", 1).
    Update(map[string]any{
        "name":  "Alice Updated",
        "age":   26,
        "email": "newemail@example.com",
    })
```

## 自增/自减

### 自增

```go
// 年龄 +1
affected, err := db.Model(&User{}).
    Where("id = ?", 1).
    Update(map[string]any{
        "age": "age + 1",  // 使用 SQL 表达式
    })
```

### 自减

```go
// 库存 -1
affected, err := db.Model(&Product{}).
    Where("id = ?", 1).
    Update(map[string]any{
        "stock": "stock - 1",
    })
```

## 更新时间字段

### 自动更新

使用 `auto_update` 标签自动更新时间：

```go
type User struct {
    ID        int64     `jorm:"pk auto"`
    Name      string
    UpdatedAt time.Time `jorm:"auto_update"`  // 自动更新
}

user := &User{Name: "Alice"}
affected, err := db.Model(&User{}).
    Where("id = ?", 1).
    Update(user)
// UpdatedAt 会自动设置为当前时间
```

### 手动更新时间

```go
affected, err := db.Model(&User{}).
    Where("id = ?", 1).
    Update(map[string]any{
        "updated_at": time.Now(),
    })
```

## 条件更新

### WHERE 条件

```go
// 使用 WHERE 条件更新
affected, err := db.Model(&User{}).
    Where("status = ?", "pending").
    Update(map[string]any{
        "status": "active",
    })
```

### OR 条件

```go
// 使用 OR 条件更新
affected, err := db.Model(&User{}).
    Where("status = ?", "pending").
    OrWhere("status = ?", "inactive").
    Update(map[string]any{
        "status": "active",
    })
```

### IN 条件

```go
// 更新多个 ID 的记录
affected, err := db.Model(&User{}).
    WhereIn("id", []int64{1, 2, 3}).
    Update(map[string]any{
        "status": "active",
    })
```

## 使用事务更新

详见 [事务处理](./08-事务处理.md)

```go
err := db.Transaction(func(tx *core.Tx) error {
    // 更新用户余额
    _, err := tx.Model(&User{}).
        Where("id = ?", 1).
        Update(map[string]any{
            "balance": "balance - 100",
        })
    if err != nil {
        return err  // 自动回滚
    }

    // 增加订单金额
    _, err = tx.Model(&Order{}).
        Where("id = ?", 1).
        Update(map[string]any{
            "total": "total + 100",
        })
    if err != nil {
        return err  // 自动回滚
    }

    return nil  // 自动提交
})

if err != nil {
    panic(err)
}

fmt.Println("更新成功")
```

## 原生 SQL 更新

详见 [原生 SQL](./15-原生SQL.md)

```go
affected, err := db.Raw(`
    UPDATE users
    SET name = ?, age = ?
    WHERE id = ?
`, "Alice", 26, 1).Exec()

if err != nil {
    panic(err)
}

fmt.Printf("更新了 %d 条记录\n", affected)
```

## 完整示例

### 更新用户信息

```go
func UpdateUser(db *core.DB, id int64, name, email string) error {
    affected, err := db.Model(&User{}).
        Where("id = ?", id).
        Update(map[string]any{
            "name":  name,
            "email": email,
        })
    if err != nil {
        return fmt.Errorf("更新用户失败: %w", err)
    }

    if affected == 0 {
        return fmt.Errorf("用户不存在")
    }

    return nil
}

// 使用
err := UpdateUser(db, 1, "Alice", "newemail@example.com")
if err != nil {
    panic(err)
}
```

### 批量更新状态

```go
func BatchUpdateStatus(db *core.DB, oldStatus, newStatus string) (int64, error) {
    affected, err := db.Model(&User{}).
        Where("status = ?", oldStatus).
        Update(map[string]any{
            "status": newStatus,
        })
    if err != nil {
        return 0, fmt.Errorf("批量更新状态失败: %w", err)
    }

    return affected, nil
}

// 使用
count, err := BatchUpdateStatus(db, "pending", "active")
if err != nil {
    panic(err)
}
fmt.Printf("更新了 %d 条记录\n", count)
```

### 软删除

```go
type User struct {
    ID        int64      `jorm:"pk auto"`
    Name      string
    DeletedAt *time.Time `jorm:"type:datetime"`
}

func SoftDeleteUser(db *core.DB, id int64) error {
    now := time.Now()
    affected, err := db.Model(&User{}).
        Where("id = ?", id).
        Update(map[string]any{
            "deleted_at": &now,
        })
    if err != nil {
        return fmt.Errorf("软删除失败: %w", err)
    }

    if affected == 0 {
        return fmt.Errorf("用户不存在")
    }

    return nil
}

// 使用
err := SoftDeleteUser(db, 1)
if err != nil {
    panic(err)
}
```

## 错误处理

### 处理不存在的记录

```go
affected, err := db.Model(&User{}).
    Where("id = ?", 9999).
    Update(map[string]any{
        "name": "Alice",
    })
if err != nil {
    panic(err)
}

if affected == 0 {
    fmt.Println("记录不存在")
}
```

### 处理唯一键冲突

```go
affected, err := db.Model(&User{}).
    Where("id = ?", 1).
    Update(map[string]any{
        "email": "existing@example.com",  // 假设已存在
    })
if err != nil {
    if errors.Is(err, core.ErrDuplicateKey) {
        fmt.Println("邮箱已被使用")
    } else {
        fmt.Printf("更新失败: %v\n", err)
    }
    return
}
```

## 性能优化

### 批量更新

```go
// 推荐：使用条件批量更新
affected, err := db.Model(&User{}).
    Where("status = ?", "inactive").
    Update(map[string]any{
        "status": "active",
    })

// 不推荐：循环更新
ids := []int64{1, 2, 3, 4, 5}
for _, id := range ids {
    db.Model(&User{}).Where("id = ?", id).Update(map[string]any{
        "status": "active",
    })
}
```

### 只更新需要的字段

```go
// 推荐：只更新需要的字段
affected, err := db.Model(&User{}).
    Where("id = ?", 1).
    Update(map[string]any{
        "name": "Alice",
    })

// 不推荐：更新所有字段
user := &User{
    ID:   1,
    Name: "Alice",
    Email: "alice@example.com",
    Age:  25,
}
db.Model(&User{}).Where("id = ?", 1).Update(user)
```

## 常见问题

### Q: 如何知道更新了多少条记录？

A: `Update()` 方法返回影响的行数：

```go
affected, err := db.Model(&User{}).
    Where("id = ?", 1).
    Update(map[string]any{"name": "Alice"})
fmt.Printf("更新了 %d 条记录\n", affected)
```

### Q: 如何实现自增/自减？

A: 使用 SQL 表达式：

```go
affected, err := db.Model(&User{}).
    Where("id = ?", 1).
    Update(map[string]any{
        "age": "age + 1",  // 自增
        "score": "score - 10",  // 自减
    })
```

### Q: 如何更新 NULL 值？

A: 使用指针类型：

```go
type User struct {
    Phone *string `jorm:"type:varchar(20)"`
}

var nullPhone *string = nil
affected, err := db.Model(&User{}).
    Where("id = ?", 1).
    Update(map[string]any{
        "phone": nullPhone,
    })
```

### Q: 如何部分更新？

A: 只更新需要修改的字段：

```go
affected, err := db.Model(&User{}).
    Where("id = ?", 1).
    Update(map[string]any{
        "name": "Alice",  // 只更新 name
    })
```

## 最佳实践

### 1. 始终检查影响行数

```go
// 推荐
affected, err := db.Model(&User{}).
    Where("id = ?", 1).
    Update(map[string]any{"name": "Alice"})
if affected == 0 {
    return fmt.Errorf("记录不存在")
}

// 不推荐
db.Model(&User{}).Where("id = ?", 1).Update(map[string]any{"name": "Alice"})
```

### 2. 使用事务处理相关更新

```go
// 推荐：使用事务
err := db.Transaction(func(tx *core.Tx) error {
    // 更新用户余额
    _, err := tx.Model(&User{}).Where("id = ?", 1).
        Update(map[string]any{"balance": "balance - 100"})
    if err != nil {
        return err
    }

    // 更新订单状态
    _, err = tx.Model(&Order{}).Where("id = ?", 1).
        Update(map[string]any{"status": "paid"})
    return err
})

// 不推荐：不使用事务
db.Model(&User{}).Where("id = ?", 1).
    Update(map[string]any{"balance": "balance - 100"})
db.Model(&Order{}).Where("id = ?", 1).
    Update(map[string]any{"status": "paid"})
```

### 3. 批量更新使用条件

```go
// 推荐
db.Model(&User{}).Where("status = ?", "pending").
    Update(map[string]any{"status": "active"})

// 不推荐
for _, user := range pendingUsers {
    db.Model(&User{}).Where("id = ?", user.ID).
        Update(map[string]any{"status": "active"})
}
```

## 下一步

- [删除操作](./07-删除操作.md) - 学习如何删除数据
- [事务处理](./08-事务处理.md) - 学习事务处理
- [性能优化](./17-性能优化.md) - 优化更新操作性能
