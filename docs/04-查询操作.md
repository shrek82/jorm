# 查询操作

本指南详细介绍 jorm 的查询功能，包括基础查询、条件查询、聚合查询等。

## 基础查询

### 查询单条记录

使用 `First()` 方法查询单条记录：

```go
var user User
err := db.Model(&User{}).Where("id = ?", 1).First(&user)
if err != nil {
    if errors.Is(err, core.ErrRecordNotFound) {
        fmt.Println("记录不存在")
        return
    }
    panic(err)
}
fmt.Printf("用户: %+v\n", user)
```

### 查询多条记录

使用 `Find()` 方法查询多条记录：

```go
var users []User
err := db.Model(&User{}).Where("age > ?", 18).Find(&users)
if err != nil {
    panic(err)
}
fmt.Printf("找到 %d 条记录\n", len(users))
```

### 查询所有记录

```go
var users []User
err := db.Model(&User{}).Find(&users)
if err != nil {
    panic(err)
}
```

## 条件查询

### Where - WHERE 条件

```go
// 简单条件
db.Model(&User{}).Where("id = ?", 1).First(&user)

// 多个条件
db.Model(&User{}).
    Where("age > ?", 18).
    Where("status = ?", "active").
    Find(&users)

// IN 条件
db.Model(&User{}).Where("id IN ?", []int64{1, 2, 3}).Find(&users)

// LIKE 条件
db.Model(&User{}).Where("name LIKE ?", "%Alice%").Find(&users)

// 多个条件 AND 连接
db.Model(&User{}).Where("age > ? AND status = ?", 18, "active").Find(&users)
```

### OrWhere - OR 条件

```go
db.Model(&User{}).
    Where("age > ?", 30).
    OrWhere("status = ?", "vip").
    Find(&users)

// 复杂的 OR 条件
db.Model(&User{}).
    Where("age > ?", 30).
    OrWhere("age < ?", 18).
    Find(&users)
```

### WhereIn - IN 条件

```go
// 使用切片
db.Model(&User{}).
    WhereIn("id", []int64{1, 2, 3}).
    Find(&users)

// 使用数组
db.Model(&User{}).
    WhereIn("status", []string{"active", "pending", "vip"}).
    Find(&users)
```

### WhereNot - NOT 条件

```go
db.Model(&User{}).
    WhereNot("status = ?", "deleted").
    Find(&users)
```

### WhereRaw - 原生 SQL 条件

```go
db.Model(&User{}).
    WhereRaw("age > ? AND created_at > ?", 18, "2024-01-01").
    Find(&users)
```

## 排序

### OrderBy - 排序

```go
// 单个字段排序（默认升序）
db.Model(&User{}).
    OrderBy("age").
    Find(&users)

// 降序排序
db.Model(&User{}).
    OrderBy("age DESC").
    Find(&users)

// 多个字段排序
db.Model(&User{}).
    OrderBy("age DESC").
    OrderBy("name ASC").
    Find(&users)
```

## 分页

### Limit - 限制记录数

```go
// 只查询前10条
db.Model(&User{}).
    Limit(10).
    Find(&users)
```

### Offset - 偏移量

```go
// 跳过前20条，查询10条
db.Model(&User{}).
    Limit(10).
    Offset(20).
    Find(&users)
```

### 完整分页示例

```go
// 分页查询
page := 1
pageSize := 10

// 计算总数
total, _ := db.Model(&User{}).Count()

// 计算总页数
totalPages := (total + pageSize - 1) / pageSize

// 查询当前页数据
var users []User
db.Model(&User{}).
    OrderBy("id DESC").
    Limit(pageSize).
    Offset((page - 1) * pageSize).
    Find(&users)

fmt.Printf("当前第 %d/%d 页，共 %d 条记录\n", page, totalPages, total)
```

## 字段选择

### Select - 选择指定字段

```go
// 选择特定字段
var users []User
db.Model(&User{}).
    Select("id", "name", "email").
    Find(&users)

// 使用别名
db.Model(&User{}).
    Select("id", "name as username", "email").
    Find(&users)
```

### Scan - 扫描到结构体

```go
type Result struct {
    Name string `jorm:"column:name"`
    Age  int    `jorm:"column:age"`
}

var results []Result
db.Model(&User{}).
    Select("name, age").
    Find(&results)
```

## 聚合查询

### Count - 计数

```go
// 统计总数
count, err := db.Model(&User{}).Count()
if err != nil {
    panic(err)
}
fmt.Printf("总用户数: %d\n", count)

// 带条件的计数
count, _ := db.Model(&User{}).
    Where("age > ?", 18).
    Count()
fmt.Printf("成年用户数: %d\n", count)
```

### Sum - 求和

```go
// 计算总和
sum, err := db.Model(&Order{}).Sum("amount")
if err != nil {
    panic(err)
}
fmt.Printf("订单总额: %.2f\n", sum)

// 带条件的求和
sum, _ = db.Model(&Order{}).
    Where("status = ?", "completed").
    Sum("amount")
```

### Avg - 平均值

```go
// 计算平均值
avg, err := db.Model(&User{}).Avg("age")
if err != nil {
    panic(err)
}
fmt.Printf("平均年龄: %.2f\n", avg)
```

### Max - 最大值

```go
// 查找最大值
max, err := db.Model(&Order{}).Max("amount")
if err != nil {
    panic(err)
}
fmt.Printf("最大订单金额: %.2f\n", max)
```

### Min - 最小值

```go
// 查找最小值
min, err := db.Model(&Order{}).Min("amount")
if err != nil {
    panic(err)
}
fmt.Printf("最小订单金额: %.2f\n", min)
```

## 分组查询

### GroupBy - 分组

```go
// 按状态分组统计
type StatusCount struct {
    Status string `jorm:"column:status"`
    Count  int64  `jorm:"column:count"`
}

var results []StatusCount
err := db.Model(&User{}).
    Select("status, COUNT(*) as count").
    GroupBy("status").
    Find(&results)
if err != nil {
    panic(err)
}

for _, r := range results {
    fmt.Printf("%s: %d\n", r.Status, r.Count)
}
```

### Having - 分组过滤

```go
// 查询用户数大于10的状态
err := db.Model(&User{}).
    Select("status, COUNT(*) as count").
    GroupBy("status").
    Having("count > ?", 10).
    Find(&results)
```

## 复杂查询示例

### 组合多个条件

```go
var users []User
err := db.Model(&User{}).
    Where("age > ?", 18).
    Where("status = ?", "active").
    OrWhere("status = ?", "vip").
    OrderBy("created_at DESC").
    Limit(20).
    Find(&users)
```

### 子查询（使用 Raw）

```go
// 使用原生 SQL 实现子查询
var users []User
err := db.Raw(`
    SELECT * FROM users
    WHERE id IN (SELECT user_id FROM orders WHERE total > 1000)
`).Scan(&users)
```

### 连接查询

```go
// 使用 Joins 进行连接
type OrderWithUser struct {
    OrderID   int64  `jorm:"column:order_id"`
    UserID    int64  `jorm:"column:user_id"`
    Amount    float64 `jorm:"column:amount"`
    UserName  string `jorm:"column:user_name"`
}

var results []OrderWithUser
err := db.Model(&Order{}).
    Select("orders.id as order_id, orders.user_id, orders.amount, users.name as user_name").
    Joins("INNER JOIN users ON users.id = orders.user_id").
    Find(&results)
```

### 聚合查询

```go
// 统计每个用户的订单数和订单总额
type UserOrderStats struct {
    UserID     int64   `jorm:"column:user_id"`
    OrderCount int64   `jorm:"column:order_count"`
    TotalAmount float64 `jorm:"column:total_amount"`
}

var stats []UserOrderStats
err := db.Model(&Order{}).
    Select("user_id, COUNT(*) as order_count, SUM(amount) as total_amount").
    GroupBy("user_id").
    Find(&stats)
```

## 表别名

### Alias - 设置表别名

```go
// 使用表别名
var users []User
err := db.Table("users").Alias("u").
    Select("u.id", "u.name", "u.email").
    Where("u.age > ?", 18).
    Find(&users)
```

### Model 方法自动使用表名

```go
// Model 会自动使用表名
var users []User
err := db.Model(&User{}).
    Where("age > ?", 18).
    Find(&users)

// 生成的 SQL: SELECT * FROM users WHERE age > ?
```

## 原生 SQL 查询

### Raw - 原生 SQL

```go
// 使用原生 SQL 查询
var users []User
err := db.Raw("SELECT * FROM users WHERE age > ?", 18).Scan(&users)
if err != nil {
    panic(err)
}
```

### 复杂的原生 SQL

```go
// 复杂的原生 SQL 查询
err := db.Raw(`
    SELECT
        u.id,
        u.name,
        COUNT(o.id) as order_count,
        SUM(o.amount) as total_amount
    FROM users u
    LEFT JOIN orders o ON o.user_id = u.id
    WHERE u.age > ?
    GROUP BY u.id, u.name
    HAVING order_count > ?
    ORDER BY total_amount DESC
    LIMIT ?
`, 18, 5, 20).Scan(&results)
```

## 查询结果处理

### 检查是否存在

```go
// 检查记录是否存在
count, _ := db.Model(&User{}).Where("id = ?", 1).Count()
if count > 0 {
    fmt.Println("记录存在")
} else {
    fmt.Println("记录不存在")
}
```

### 只查询第一条

```go
// 只查询第一条记录
var user User
err := db.Model(&User{}).Where("age > ?", 18).First(&user)
if err != nil {
    if errors.Is(err, core.ErrRecordNotFound) {
        fmt.Println("没有找到记录")
        return
    }
    panic(err)
}
```

### 查询并遍历

```go
var users []User
err := db.Model(&User{}).Find(&users)
if err != nil {
    panic(err)
}

for _, user := range users {
    fmt.Printf("ID: %d, Name: %s\n", user.ID, user.Name)
}
```

## 性能优化

### 只查询需要的字段

```go
// 推荐：只查询需要的字段
var users []User
err := db.Model(&User{}).
    Select("id", "name", "email").
    Find(&users)

// 不推荐：查询所有字段
var users []User
err := db.Model(&User{}).Find(&users)
```

### 使用索引

```go
// 在模型中定义索引
type User struct {
    ID    int64  `jorm:"pk auto"`
    Email string `jorm:"size:100 unique index"`  // 唯一索引
    Age   int    `jorm:"index"`                   // 普通索引
}

// 查询时使用索引字段
db.Model(&User{}).Where("email = ?", "user@example.com").First(&user)
```

### 分页查询大数据集

```go
// 使用游标分页（更高效）
type CursorResult struct {
    ID      int64
    Name    string
    Cursor  int64  `jorm:"column:id"`  // 使用 ID 作为游标
}

pageSize := 100
lastID := int64(0)

for {
    var results []CursorResult
    err := db.Model(&User{}).
        Select("id, name, id as cursor").
        Where("id > ?", lastID).
        OrderBy("id ASC").
        Limit(pageSize).
        Find(&results)

    if err != nil || len(results) == 0 {
        break
    }

    // 处理结果
    for _, r := range results {
        fmt.Printf("ID: %d, Name: %s\n", r.ID, r.Name)
    }

    // 更新游标
    lastID = results[len(results)-1].Cursor
}
```

## 查询调试

### 使用日志查看 SQL

```go
import "github.com/shrek82/jorm/logger"

// 设置日志级别为 Info
log := logger.NewStdLogger()
log.SetLevel(logger.Info)
db.SetLogger(log)

// 现在所有查询都会打印 SQL
db.Model(&User{}).Where("id = ?", 1).First(&user)
// 输出: [SQL] SELECT * FROM users WHERE id = ? [1]
```

### 使用 LastSQL 查看最后执行的 SQL

```go
db.Model(&User{}).Where("id = ?", 1).First(&user)

// 获取最后执行的 SQL
sql, args := db.LastSQL()
fmt.Printf("SQL: %s\n", sql)
fmt.Printf("Args: %v\n", args)
```

## 常见查询场景

### 1. 用户登录查询

```go
var user User
err := db.Model(&User{}).
    Where("email = ? AND password = ?", email, hashedPassword).
    First(&user)
if err != nil {
    if errors.Is(err, core.ErrRecordNotFound) {
        return fmt.Errorf("用户名或密码错误")
    }
    return err
}
```

### 2. 搜索功能

```go
keyword := "Alice"
var users []User
err := db.Model(&User{}).
    Where("name LIKE ? OR email LIKE ?", "%"+keyword+"%", "%"+keyword+"%").
    OrderBy("created_at DESC").
    Limit(20).
    Find(&users)
```

### 3. 统计报表

```go
// 每日订单统计
type DailyStats struct {
    Date     string  `jorm:"column:date"`
    Count    int64   `jorm:"column:count"`
    Total    float64 `jorm:"column:total"`
}

var stats []DailyStats
err := db.Model(&Order{}).
    Select("DATE(created_at) as date, COUNT(*) as count, SUM(amount) as total").
    Where("created_at >= ?", time.Now().AddDate(0, 0, -30)).
    GroupBy("DATE(created_at)").
    OrderBy("date ASC").
    Find(&stats)
```

### 4. 最近的记录

```go
var users []User
err := db.Model(&User{}).
    OrderBy("created_at DESC").
    Limit(10).
    Find(&users)
```

### 5. 随机记录

```go
// MySQL
var users []User
err := db.Model(&User{}).
    OrderBy("RAND()").
    Limit(5).
    Find(&users)

// PostgreSQL
err := db.Model(&User{}).
    OrderBy("RANDOM()").
    Limit(5).
    Find(&users)

// SQLite
err := db.Model(&User{}).
    OrderBy("RANDOM()").
    Limit(5).
    Find(&users)
```

## 最佳实践

### 1. 始终检查错误

```go
// 推荐
err := db.Model(&User{}).Where("id = ?", 1).First(&user)
if err != nil {
    if errors.Is(err, core.ErrRecordNotFound) {
        // 处理记录不存在
    }
    return err
}

// 不推荐
db.Model(&User{}).Where("id = ?", 1).First(&user)
```

### 2. 使用参数化查询防止 SQL 注入

```go
// 推荐：使用参数化查询
db.Model(&User{}).Where("name = ?", userInput).Find(&users)

// 不推荐：拼接 SQL（有 SQL 注入风险）
db.Model(&User{}).Where("name = '" + userInput + "'").Find(&users)
```

### 3. 合理使用 Limit

```go
// 推荐：限制返回的记录数
db.Model(&User{}).Limit(100).Find(&users)

// 不推荐：可能返回大量数据
db.Model(&User{}).Find(&users)
```

### 4. 选择必要的字段

```go
// 推荐：只查询需要的字段
db.Model(&User{}).Select("id, name").Find(&users)

// 不推荐：查询所有字段
db.Model(&User{}).Find(&users)
```

## 下一步

- [插入操作](./05-插入操作.md) - 学习如何插入数据
- [更新操作](./06-更新操作.md) - 学习如何更新数据
- [删除操作](./07-删除操作.md) - 学习如何删除数据
- [关联关系](./10-关联关系.md) - 学习关联查询
