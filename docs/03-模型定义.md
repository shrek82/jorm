# 模型定义

本指南详细介绍如何在 jorm 中定义数据模型，包括字段类型、标签、表名映射等。

## 基本模型定义

```go
type User struct {
    ID        int64     `jorm:"pk auto"`
    Name      string    `jorm:"size:100 notnull"`
    Email     string    `jorm:"size:100 unique"`
    Age       int       `jorm:"default:0"`
    CreatedAt time.Time `jorm:"auto_time"`
    UpdatedAt time.Time `jorm:"auto_update"`
}
```

## 命名约定

### 表名

jorm 自动将结构体名转换为蛇形命名：

| 结构体名         | 表名            |
|----------------|----------------|
| `User`         | `user`         |
| `UserProfile`  | `user_profile` |
| `OrderItem`    | `order_item`   |
| `HTTPResponse` | `http_response` |

### 字段名

同样自动将字段名转换为蛇形命名：

| 字段名       | 列名         |
|------------|-------------|
| `ID`       | `id`        |
| `Name`     | `name`      |
| `UserID`   | `user_id`   |
| `CreatedAt`| `created_at`|

### 自定义表名

实现 `TableName()` 方法自定义表名：

```go
type User struct {
    ID   int64
    Name string
}

func (u *User) TableName() string {
    return "my_users"
}
```

## jorm 标签详解

### 基础标签

#### pk - 主键

```go
type User struct {
    ID int64 `jorm:"pk"`  // 主键
}
```

#### auto - 自增

```go
type User struct {
    ID int64 `jorm:"pk auto"`  // 主键，自增
}
```

#### column - 列名

```go
type User struct {
    ID       int64  `jorm:"column:user_id"`        // 指定列名
    UserName string `jorm:"column:user_name"`     // 指定列名
}
```

#### size - 字段大小

```go
type User struct {
    Name  string `jorm:"size:100"`   // VARCHAR(100)
    Email string `jorm:"size:255"`   // VARCHAR(255)
}
```

#### type - 数据类型

```go
type User struct {
    Name     string    `jorm:"type:varchar(100)"`
    Age      int       `jorm:"type:int unsigned"`
    Price    float64   `jorm:"type:decimal(10,2)"`
    Status   bool      `jorm:"type:boolean"`
    Content  string    `jorm:"type:text"`
    Metadata string    `jorm:"type:json"`
}
```

### 约束标签

#### notnull - 非空

```go
type User struct {
    Name string `jorm:"notnull"`  // NOT NULL
}
```

#### unique - 唯一

```go
type User struct {
    Email string `jorm:"unique"`  // UNIQUE
}
```

#### default - 默认值

```go
type User struct {
    Status  string `jorm:"default:'active'"`  // 字符串默认值
    Age     int    `jorm:"default:0"`          // 数值默认值
    Active  bool   `jorm:"default:true"`       // 布尔默认值
}
```

### 时间标签

#### auto_time - 自动设置插入时间

```go
type User struct {
    CreatedAt time.Time `jorm:"auto_time"`
}
```

插入记录时，`CreatedAt` 会自动设置为当前时间。

#### auto_update - 自动设置更新时间

```go
type User struct {
    UpdatedAt time.Time `jorm:"auto_update"`
}
```

更新记录时，`UpdatedAt` 会自动设置为当前时间。

### 关系标签

#### fk - 外键

```go
type Order struct {
    ID     int64 `jorm:"pk auto"`
    UserID int64 `jorm:"fk:User.ID"`  // 外键关联到 User.ID
    Amount float64
}
```

### 其他标签

#### `-` - 忽略字段

```go
type User struct {
    ID      int64  `jorm:"pk"`
    Name    string
    Password string `jorm:"-"`  // 不映射到数据库
}
```

## 完整模型示例

```go
type User struct {
    // 基础字段
    ID        int64      `jorm:"pk auto column:id"`
    Name      string     `jorm:"size:100 notnull column:name"`
    Email     string     `jorm:"size:100 unique notnull column:email"`

    // 数值类型
    Age       int        `jorm:"type:int unsigned default:0 column:age"`
    Score     float64    `jorm:"type:decimal(10,2) default:0.00 column:score"`

    // 布尔类型
    IsActive  bool       `jorm:"type:boolean default:true column:is_active"`

    // 文本类型
    Bio       string     `jorm:"type:text column:bio"`

    // 二进制类型
    Avatar    []byte     `jorm:"type:blob column:avatar"`

    // 时间类型
    BirthDate *time.Time `jorm:"type:date column:birth_date"`
    LastLogin *time.Time `jorm:"type:datetime column:last_login"`
    CreatedAt time.Time  `jorm:"auto_time column:created_at"`
    UpdatedAt time.Time  `jorm:"auto_update column:updated_at"`

    // JSON 类型
    Metadata string     `jorm:"type:json column:metadata"`
}
```

## Go 类型与数据库类型映射

### MySQL

| Go 类型           | 默认映射         | 使用 type 标签映射               |
|-----------------|----------------|-------------------------------|
| `int`           | `INT`          | `type:int`                    |
| `int8`          | `TINYINT`      | `type:tinyint`                |
| `int16`         | `SMALLINT`     | `type:smallint`               |
| `int32`         | `INT`          | `type:int`                    |
| `int64`         | `BIGINT`       | `type:bigint`                 |
| `uint`          | `INT UNSIGNED` | `type:int unsigned`           |
| `uint8`         | `TINYINT UNSIGNED` | `type:tinyint unsigned`    |
| `uint16`        | `SMALLINT UNSIGNED` | `type:smallint unsigned`  |
| `uint32`        | `INT UNSIGNED` | `type:int unsigned`           |
| `uint64`        | `BIGINT UNSIGNED` | `type:bigint unsigned`   |
| `float32`       | `FLOAT`        | `type:float`                  |
| `float64`       | `DOUBLE`       | `type:double`                 |
| `string`        | `VARCHAR(255)` | `type:varchar(100)`            |
| `[]byte`        | `BLOB`         | `type:blob`                   |
| `time.Time`     | `DATETIME`     | `type:datetime`               |
| `bool`          | `TINYINT(1)`   | `type:boolean`                 |

### PostgreSQL

| Go 类型           | 默认映射         | 使用 type 标签映射               |
|-----------------|----------------|-------------------------------|
| `int`           | `INTEGER`      | `type:integer`                |
| `int64`         | `BIGINT`       | `type:bigint`                 |
| `float64`       | `DOUBLE PRECISION` | `type:double`           |
| `string`        | `VARCHAR(255)` | `type:varchar(100)`            |
| `[]byte`        | `BYTEA`        | `type:bytea`                  |
| `time.Time`     | `TIMESTAMP`    | `type:timestamp`              |
| `bool`          | `BOOLEAN`      | `type:boolean`                |

### SQLite

| Go 类型           | 默认映射         | 使用 type 标签映射               |
|-----------------|----------------|-------------------------------|
| `int`           | `INTEGER`      | `type:integer`                |
| `int64`         | `INTEGER`      | `type:bigint`                 |
| `float64`       | `REAL`         | `type:real`                   |
| `string`        | `TEXT`         | `type:text`                   |
| `[]byte`        | `BLOB`         | `type:blob`                   |
| `time.Time`     | `DATETIME`     | `type:datetime`               |
| `bool`          | `INTEGER`      | `type:boolean`                |

## 指针类型

使用指针类型处理可空字段：

```go
type User struct {
    ID        int64      `jorm:"pk auto"`
    Name      string     `jorm:"notnull"`
    Age       *int       `jorm:"type:int"`  // 可空整数
    Phone     *string    `jorm:"type:varchar(20)"`  // 可空字符串
    DeletedAt *time.Time `jorm:"type:datetime"`  // 可空时间（软删除）
}
```

使用示例：

```go
// 插入数据
user := &User{
    Name: "Alice",
    Age:  nil,    // 插入 NULL
    Phone: nil,   // 插入 NULL
}
db.Model(user).Insert(user)

// 查询后，NULL 字段会是 nil
var user User
db.Model(&User{}).Where("id = ?", 1).First(&user)
if user.Phone == nil {
    fmt.Println("Phone is NULL")
}
```

## 嵌入结构体

```go
type BaseModel struct {
    ID        int64     `jorm:"pk auto"`
    CreatedAt time.Time `jorm:"auto_time"`
    UpdatedAt time.Time `jorm:"auto_update"`
}

type User struct {
    BaseModel  // 嵌入基础模型
    Name       string `jorm:"size:100 notnull"`
    Email      string `jorm:"size:100 unique"`
}

// User 表包含字段：id, created_at, updated_at, name, email
```

## 自定义验证方法

```go
type User struct {
    ID   int64  `jorm:"pk auto"`
    Name string `jorm:"size:100 notnull"`
    Age  int
}

// TableName 自定义表名
func (u *User) TableName() string {
    return "my_users"
}

// BeforeInsert 插入前钩子
func (u *User) BeforeInsert() error {
    if u.Name == "" {
        return fmt.Errorf("name cannot be empty")
    }
    if u.Age < 0 {
        return fmt.Errorf("age cannot be negative")
    }
    return nil
}
```

## 复杂模型示例

### 用户模型

```go
type User struct {
    // 主键
    ID int64 `jorm:"pk auto column:id"`

    // 基本信息
    Username  string `jorm:"size:50 unique notnull column:username"`
    Email     string `jorm:"size:100 unique notnull column:email"`
    Password  string `jorm:"size:255 notnull column:password"`  // 哈希后的密码

    // 个人信息
    FirstName string     `jorm:"size:50 column:first_name"`
    LastName  string     `jorm:"size:50 column:last_name"`
    Bio       string     `jorm:"type:text column:bio"`
    Avatar    []byte     `jorm:"type:blob column:avatar"`

    // 状态信息
    Status    string `jorm:"size:20 default:'active' column:status"`
    IsActive  bool   `jorm:"type:boolean default:true column:is_active"`

    // 时间信息
    LastLogin *time.Time `jorm:"type:datetime column:last_login"`
    CreatedAt time.Time  `jorm:"auto_time column:created_at"`
    UpdatedAt time.Time  `jorm:"auto_update column:updated_at"`

    // 软删除
    DeletedAt *time.Time `jorm:"type:datetime column:deleted_at"`
}
```

### 订单模型

```go
type Order struct {
    // 主键
    ID int64 `jorm:"pk auto column:id"`

    // 关联信息
    UserID int64 `jorm:"fk:User.ID column:user_id notnull"`

    // 订单信息
    OrderNo   string    `jorm:"size:50 unique notnull column:order_no"`
    Total     float64   `jorm:"type:decimal(10,2) default:0.00 column:total"`
    Status    string    `jorm:"size:20 default:'pending' column:status"`
    Note      string    `jorm:"type:text column:note"`

    // 时间信息
    PaidAt    *time.Time `jorm:"type:datetime column:paid_at"`
    ShippedAt *time.Time `jorm:"type:datetime column:shipped_at"`
    CreatedAt time.Time  `jorm:"auto_time column:created_at"`
    UpdatedAt time.Time  `jorm:"auto_update column:updated_at"`
}
```

### 产品模型

```go
type Product struct {
    // 主键
    ID int64 `jorm:"pk auto column:id"`

    // 基本信息
    Name        string  `jorm:"size:200 notnull column:name"`
    Description string  `jorm:"type:text column:description"`
    SKU         string  `jorm:"size:50 unique column:sku"`

    // 价格信息
    Price       float64 `jorm:"type:decimal(10,2) notnull column:price"`
    ComparePrice float64 `jorm:"type:decimal(10,2) column:compare_price"`
    CostPrice   float64 `jorm:"type:decimal(10,2) column:cost_price"`

    // 库存信息
    Stock       int     `jorm:"type:int default:0 column:stock"`
    StockStatus string  `jorm:"size:20 default:'in_stock' column:stock_status"`

    // 元数据
    Metadata    string  `jorm:"type:json column:metadata"`

    // 时间信息
    PublishedAt *time.Time `jorm:"type:datetime column:published_at"`
    CreatedAt   time.Time  `jorm:"auto_time column:created_at"`
    UpdatedAt   time.Time  `jorm:"auto_update column:updated_at"`
}
```

## 表结构迁移

使用 `AutoMigrate` 自动创建表：

```go
db.AutoMigrate(&User{}, &Order{}, &Product{})
```

`AutoMigrate` 会：
1. 检查表是否存在
2. 如果不存在，创建表
3. 如果存在，添加缺失的字段
4. 不会删除字段或修改已有字段

## 最佳实践

### 1. 推荐使用分号分隔标签

虽然 jorm 支持空格、逗号和分号作为标签分隔符，但推荐使用 **分号 (;)**，这与 GORM 等主流 ORM 保持一致，且兼容性更好。

```go
// 推荐：使用分号分隔
type User struct {
    Name  string `jorm:"size:100;notnull"`
    Email string `jorm:"size:100;unique"`
}

// 也支持（但不推荐）：使用空格分隔
type User struct {
    Name  string `jorm:"size:100 notnull"`
}
```

### 2. 使用一致的命名

```go
// 推荐：使用一致的命名风格
type User struct {
    ID        int64     `jorm:"pk auto"`
    CreatedAt time.Time `jorm:"auto_time"`
    UpdatedAt time.Time `jorm:"auto_update"`
}
```

### 2. 合理使用类型约束

```go
// 推荐：明确指定类型和约束
type User struct {
    Email string `jorm:"size:100 unique notnull"`
    Age   int    `jorm:"type:int unsigned default:0"`
}

// 不推荐：依赖默认类型
type User struct {
    Email string
    Age   int
}
```

### 3. 使用指针处理可空字段

```go
// 推荐
type User struct {
    Phone *string    // 可空
}

// 不推荐
type User struct {
    Phone string     // 默认值是空字符串，不是 NULL
}
```

### 4. 使用嵌入结构体减少重复

```go
// 推荐
type BaseModel struct {
    ID        int64     `jorm:"pk auto"`
    CreatedAt time.Time `jorm:"auto_time"`
    UpdatedAt time.Time `jorm:"auto_update"`
}

type User struct {
    BaseModel
    Name string
}

// 不推荐
type User struct {
    ID        int64     `jorm:"pk auto"`
    Name      string
    CreatedAt time.Time `jorm:"auto_time"`
    UpdatedAt time.Time `jorm:"auto_update"`
}
```

## 下一步

- [查询操作](./04-查询操作.md) - 学习如何查询数据
- [插入操作](./05-插入操作.md) - 学习如何插入数据
- [钩子函数](./09-钩子函数.md) - 了解模型钩子函数
