# JORM ä¼˜åŒ–æ¸…å• 2.0

> JORM è½»é‡çº§ ORM é¡¹ç›®ä¼˜åŒ–å»ºè®®
> ç”Ÿæˆæ—¥æœŸ: 2026-01-15
> åˆ†æåŸºç¡€: 21ä¸ªGoæºæ–‡ä»¶,ä»£ç è¡Œæ•°çº¦2000+

---

## ğŸ”´ é«˜ä¼˜å…ˆçº§ (P0) - æ ¸å¿ƒé—®é¢˜

### 1. æµ‹è¯•è¦†ç›–ç‡æä½
**å½“å‰çŠ¶æ€**: æµ‹è¯•è¦†ç›–ç‡ 0%
**ä½ç½®**: æ‰€æœ‰æ¨¡å—

**ä¸è¶³ä¹‹å¤„**:
- ç¼ºå°‘å•å…ƒæµ‹è¯•å¯¼è‡´ä»£ç å¥å£®æ€§æ— æ³•ä¿è¯
- é‡æ„é£é™©é«˜,æ— æ³•å›å½’æµ‹è¯•
- æ€§èƒ½ä¼˜åŒ–åæ— æ³•éªŒè¯æ­£ç¡®æ€§

**ä¼˜åŒ–å»ºè®®**:
```go
// ä¸ºæ¯ä¸ªæ ¸å¿ƒæ¨¡å—ç¼–å†™å•å…ƒæµ‹è¯•
// core/query.go - CRUDæ“ä½œæµ‹è¯•
// model/model.go - æ¨¡å‹è§£ææµ‹è¯•
// dialect/* - æ–¹è¨€å®ç°æµ‹è¯•
// builder.go - SQLæ„å»ºæµ‹è¯•
```

**ä¼˜åŒ–åå¥½å¤„**:
- æé«˜ä»£ç è´¨é‡å’Œå¯ç»´æŠ¤æ€§
- é™ä½é‡æ„é£é™©
- ä¾¿äºCI/CDé›†æˆ
- æå‡é¡¹ç›®å¯ä¿¡åº¦

**é¢„è®¡å·¥ä½œé‡**: 5-7å¤©

---

### 2. SQLæ³¨å…¥é£é™© - Joinsæ–¹æ³•
**å½“å‰çŠ¶æ€**: ç›´æ¥æ‹¼æ¥åŸå§‹SQLå­—ç¬¦ä¸²
**ä½ç½®**: `core/builder.go:160`, `core/query.go:187`

**ä¸è¶³ä¹‹å¤„**:
```go
// å½“å‰å®ç° - ä¸å®‰å…¨
func (b *sqlBuilder) Joins(query string, args ...any) Builder {
    b.joins = append(b.joins, query)  // ç›´æ¥æ‹¼æ¥,å¯èƒ½æ³¨å…¥
    b.joinArgs = append(b.joinArgs, args...)
    return b
}
```

**ä¼˜åŒ–å»ºè®®**:
```go
// å¢åŠ JOINè¯­å¥éªŒè¯
func (b *sqlBuilder) Joins(query string, args ...any) Builder {
    // 1. éªŒè¯SQLå…³é”®å­—
    if !isValidJoinClause(query) {
        panic("invalid join clause")
    }
    // 2. ä½¿ç”¨é¢„ç¼–è¯‘å ä½ç¬¦
    normalized := b.replacePlaceholders(query)
    b.joins = append(b.joins, normalized)
    b.joinArgs = append(b.joinArgs, args...)
    return b
}
```

**ä¼˜åŒ–åå¥½å¤„**:
- æ¶ˆé™¤SQLæ³¨å…¥é£é™©
- æé«˜å®‰å…¨æ€§
- ç¬¦åˆå®‰å…¨æœ€ä½³å®è·µ

**é¢„è®¡å·¥ä½œé‡**: 1-2å¤©

---

### 3. é”™è¯¯å¤„ç†ç¼ºä¹ä¸Šä¸‹æ–‡
**å½“å‰çŠ¶æ€**: é”™è¯¯ä¿¡æ¯ç®€å•,éš¾ä»¥å®šä½é—®é¢˜
**ä½ç½®**: `core/query.go`, `model/model.go`, `core/builder.go`

**ä¸è¶³ä¹‹å¤„**:
```go
// å½“å‰å®ç°
if err != nil {
    return err  // æ— ä¸Šä¸‹æ–‡ä¿¡æ¯
}
```

**ä¼˜åŒ–å»ºè®®**:
```go
// ä½¿ç”¨é”™è¯¯åŒ…è£…
import "errors"
import "fmt"

if err != nil {
    return fmt.Errorf("failed to insert model %s: %w", m.TableName, err)
}

// å®šä¹‰é”™è¯¯ç±»å‹
var (
    ErrModelNotFound    = errors.New("model not found")
    ErrInvalidQuery     = errors.New("invalid query")
    ErrRelationNotFound = errors.New("relation not found")
)
```

**ä¼˜åŒ–åå¥½å¤„**:
- å¿«é€Ÿå®šä½é—®é¢˜æ ¹æº
- ä¾¿äºæ—¥å¿—è¿½è¸ª
- æ”¯æŒé”™è¯¯ç±»å‹åˆ¤æ–­ (`errors.Is`, `errors.As`)

**é¢„è®¡å·¥ä½œé‡**: 2-3å¤©

---

### 4. åå°„æ€§èƒ½ä¼˜åŒ–ä¸è¶³
**å½“å‰çŠ¶æ€**: æ¯æ¬¡æŸ¥è¯¢éƒ½è¿›è¡Œåå°„æ“ä½œ
**ä½ç½®**: `core/query.go:288-298`, `core/query.go:370-398`

**ä¸è¶³ä¹‹å¤„**:
- `scanRowWithPlan` æ¯æ¬¡éƒ½åˆ›å»ºæ–°çš„åå°„å€¼
- ç¼ºå°‘ç±»å‹è½¬æ¢ç¼“å­˜
- å¤§é‡ä¸´æ—¶å¯¹è±¡åˆ†é…

**ä¼˜åŒ–å»ºè®®**:
```go
// 1. ä½¿ç”¨é¢„åˆ†é…çš„å€¼ç¼“å†²åŒº
type scanBuffer struct {
    values []any
    ptrs   []reflect.Value
}

var scanBufferPool = sync.Pool{
    New: func() any {
        return &scanBuffer{
            values: make([]any, 32),
        }
    },
}

// 2. ç¼“å­˜ç±»å‹è½¬æ¢æ–¹æ³•
type converter func(src, dst reflect.Value) error
var converterCache sync.Map

// 3. æ‰¹é‡å¤„ç†ä¼˜åŒ–
func batchScan(rows *sql.Rows, destSlice reflect.Value, plan *scanPlan) error {
    // å‡å°‘åå°„è°ƒç”¨æ¬¡æ•°
}
```

**ä¼˜åŒ–åå¥½å¤„**:
- æŸ¥è¯¢æ€§èƒ½æå‡ 30-50%
- å‡å°‘GCå‹åŠ›
- æ›´å¥½çš„å†…å­˜ä½¿ç”¨

**é¢„è®¡å·¥ä½œé‡**: 3-4å¤©

---

### 5. å¹¶å‘å®‰å…¨ - å…³ç³»ç¼“å­˜å¤±æ•ˆ
**å½“å‰çŠ¶æ€**: ä½¿ç”¨å…¨å±€å˜é‡æ›¿æ¢ç¼“å­˜
**ä½ç½®**: `model/relation.go:238-240`

**ä¸è¶³ä¹‹å¤„**:
```go
// å±é™©!ç›´æ¥æ›¿æ¢å…¨å±€map
func InvalidateRelationCache() {
    relationCache = sync.Map{}  // ç«æ€æ¡ä»¶
}
```

**ä¼˜åŒ–å»ºè®®**:
```go
// ä½¿ç”¨åŸå­æ“ä½œæˆ–ç‰ˆæœ¬å·æœºåˆ¶
var relationCacheVersion atomic.Uint64

func InvalidateRelationCache() {
    relationCacheVersion.Add(1)
}

func GetRelation(m *Model, name string) (*Relation, error) {
    key := m.TableName + "." + name
    version := relationCacheVersion.Load()

    cached, ok := relationCache.Load(key)
    if ok {
        rel := cached.(*relationWithVersion)
        if rel.version == version {
            return rel.relation, nil
        }
    }

    // é‡æ–°è§£æ
    relation, err := parseRelationFromTyp(m.OriginalType, name)
    if err != nil {
        return nil, err
    }

    relationCache.Store(key, &relationWithVersion{
        relation: relation,
        version:  version,
    })
    return relation, nil
}
```

**ä¼˜åŒ–åå¥½å¤„**:
- æ¶ˆé™¤ç«æ€æ¡ä»¶
- ä¿è¯å¹¶å‘å®‰å…¨
- é¿å…æ•°æ®ä¸ä¸€è‡´

**é¢„è®¡å·¥ä½œé‡**: 1å¤©

---

## ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ (P1) - åŠŸèƒ½å¢å¼º

### 6. è¿æ¥æ± æŒ‡æ ‡ç¼ºå¤±
**å½“å‰çŠ¶æ€**: æ— æ³•è·å–è¿æ¥æ± çŠ¶æ€
**ä½ç½®**: `pool/pool.go`

**ä¸è¶³ä¹‹å¤„**:
- ç¼ºå°‘è¿æ¥æ•°ç»Ÿè®¡
- æ— æ³•ç›‘æ§è¿æ¥æ± å¥åº·åº¦
- è°ƒä¼˜å›°éš¾

**ä¼˜åŒ–å»ºè®®**:
```go
// æ‰©å±•Poolæ¥å£
type Pool interface {
    Close() error
    SetMaxOpenConns(n int)
    SetMaxIdleConns(n int)
    SetConnMaxLifetime(d time.Duration)
    Ping() error
    ExecContext(ctx context.Context, query string, args ...any) (sql.Result, error)
    QueryContext(ctx context.Context, query string, args ...any) (*sql.Rows, error)
    QueryRowContext(ctx context.Context, query string, args ...any) *sql.Row
    Begin() (*sql.Tx, error)

    // æ–°å¢
    Stats() PoolStats  // è¿æ¥æ± ç»Ÿè®¡
}

type PoolStats struct {
    MaxOpenConnections int
    OpenConnections    int
    InUse              int
    Idle               int
    WaitCount          int64
    WaitDuration       time.Duration
}
```

**ä¼˜åŒ–åå¥½å¤„**:
- å®æ—¶ç›‘æ§è¿æ¥æ± çŠ¶æ€
- ä¾¿äºæ€§èƒ½è°ƒä¼˜
- åŠæ—¶å‘ç°è¿æ¥æ³„æ¼

**é¢„è®¡å·¥ä½œé‡**: 1å¤©

---

### 7. æ‰¹é‡æ’å…¥ä¼˜åŒ– - æ•°æ®åº“å·®å¼‚
**å½“å‰çŠ¶æ€**: æ‰€æœ‰æ•°æ®åº“ä½¿ç”¨ç›¸åŒçš„æ‰¹é‡æ’å…¥ç­–ç•¥
**ä½ç½®**: `dialect/mysql.go:72-88`, `dialect/sqlite3.go:75-91`

**ä¸è¶³ä¹‹å¤„**:
- SQLite å¯èƒ½ä¸æ”¯æŒå¤šå€¼æ’å…¥
- PostgreSQL ä½¿ç”¨ä¸åŒè¯­æ³•
- MySQL é™åˆ¶å•æ¬¡æ’å…¥è¡Œæ•°

**ä¼˜åŒ–å»ºè®®**:
```go
// MySQL: å•æ¡è¯­å¥å¤šå€¼
INSERT INTO table (a,b) VALUES (?,?), (?,?), (??)

// SQLite: å¤šæ¡è¯­å¥
BEGIN;
INSERT INTO table (a,b) VALUES (?,?);
INSERT INTO table (a,b) VALUES (?,?);
COMMIT;

// PostgreSQL: INSERT ... ON CONFLICT
INSERT INTO table (a,b) VALUES (?,?) ON CONFLICT DO NOTHING;

// åœ¨BatchInsertSQLä¸­å®ç°æ•°æ®åº“ç‰¹å®šé€»è¾‘
func (d *postgres) BatchInsertSQL(table string, columns []string, count int) (string, []any) {
    // ä½¿ç”¨COPYæˆ–æ‰¹é‡INSERT
}
```

**ä¼˜åŒ–åå¥½å¤„**:
- é’ˆå¯¹ä¸åŒæ•°æ®åº“æœ€ä¼˜å®ç°
- æ‰¹é‡æ’å…¥æ€§èƒ½æå‡ 50-200%
- ç¬¦åˆæ•°æ®åº“æœ€ä½³å®è·µ

**é¢„è®¡å·¥ä½œé‡**: 2-3å¤©

---

### 8. ç»“æ„åŒ–æ—¥å¿—æ”¯æŒ
**å½“å‰çŠ¶æ€**: ä»…æ”¯æŒç®€å•æ–‡æœ¬æ—¥å¿—
**ä½ç½®**: `logger/logger.go`

**ä¸è¶³ä¹‹å¤„**:
- ä¸æ”¯æŒJSONæ ¼å¼
- ç¼ºå°‘æ—¥å¿—çº§åˆ«ç»†ç²’åº¦æ§åˆ¶
- æ— æ³•æŒä¹…åŒ–åˆ°æ–‡ä»¶
- ä¸æ”¯æŒç»“æ„åŒ–å­—æ®µ

**ä¼˜åŒ–å»ºè®®**:
```go
// æ‰©å±•Loggeræ¥å£
type Logger interface {
    SetLevel(level LogLevel)
    SetFormat(format LogFormat)  // "text", "json"
    SetOutput(w io.Writer)
    WithFields(fields map[string]any) FieldLogger
    Info(format string, args ...any)
    Warn(format string, args ...any)
    Error(format string, args ...any)
    SQL(sql string, duration time.Duration, args ...any)
}

// JSONæ ¼å¼å®ç°
type jsonLogger struct {
    encoder *json.Encoder
    level   LogLevel
    fields  map[string]any
}

// ä½¿ç”¨ç¤ºä¾‹
db.SetLogger(&jsonLogger{
    level:   LogLevelInfo,
    encoder: json.NewEncoder(os.Stdout),
})
```

**ä¼˜åŒ–åå¥½å¤„**:
- ä¾¿äºæ—¥å¿—èšåˆå’Œåˆ†æ
- æ”¯æŒELKç­‰æ—¥å¿—ç³»ç»Ÿ
- æ›´å¥½çš„æ—¥å¿—æŸ¥è¯¢å’Œè¿‡æ»¤
- ç”Ÿäº§ç¯å¢ƒå‹å¥½

**é¢„è®¡å·¥ä½œé‡**: 2å¤©

---

### 9. äº‹åŠ¡éš”ç¦»çº§åˆ«æ”¯æŒ
**å½“å‰çŠ¶æ€**: ä¸æ”¯æŒé…ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«
**ä½ç½®**: `core/db.go:113-145`, `core/tx.go`

**ä¸è¶³ä¹‹å¤„**:
- æ— æ³•æ§åˆ¶äº‹åŠ¡éš”ç¦»çº§åˆ«
- å¯èƒ½å¯¼è‡´å¹¶å‘é—®é¢˜
- ä¸æ»¡è¶³æŸäº›ä¸šåŠ¡åœºæ™¯éœ€æ±‚

**ä¼˜åŒ–å»ºè®®**:
```go
// å®šä¹‰éš”ç¦»çº§åˆ«
type IsolationLevel int

const (
    LevelDefault IsolationLevel = iota
    LevelReadUncommitted
    LevelReadCommitted
    LevelRepeatableRead
    LevelSerializable
)

// äº‹åŠ¡é€‰é¡¹
type TxOptions struct {
    Isolation IsolationLevel
    ReadOnly  bool
}

// Beginæ‰©å±•
func (db *DB) BeginWithOpts(opts *TxOptions) (*Tx, error) {
    sqlOpts := &sql.TxOptions{}
    if opts != nil {
        sqlOpts.Isolation = sql.IsolationLevel(opts.Isolation)
        sqlOpts.ReadOnly = opts.ReadOnly
    }
    sqlTx, err := db.pool.BeginTx(context.Background(), sqlOpts)
    if err != nil {
        return nil, err
    }
    return &Tx{db: db, sqlTx: sqlTx}, nil
}

// å‡½æ•°å¼äº‹åŠ¡æ”¯æŒé€‰é¡¹
func (db *DB) TransactionWithOpts(fn func(tx *Tx) error, opts *TxOptions) error {
    tx, err := db.BeginWithOpts(opts)
    // ...
}
```

**ä¼˜åŒ–åå¥½å¤„**:
- æ›´çµæ´»çš„äº‹åŠ¡æ§åˆ¶
- é¿å…å¹¶å‘å†²çª
- æ»¡è¶³ä¸åŒä¸šåŠ¡åœºæ™¯

**é¢„è®¡å·¥ä½œé‡**: 1-2å¤©

---

### 10. AutoMigrate å¢å¼ºåŠŸèƒ½
**å½“å‰çŠ¶æ€**: ä»…æ”¯æŒåˆ›å»ºè¡¨,ä¸æ”¯æŒä¿®æ”¹è¡¨ç»“æ„
**ä½ç½®**: `core/db.go:147-175`

**ä¸è¶³ä¹‹å¤„**:
- æ— æ³•è‡ªåŠ¨è¿ç§»è¡¨ç»“æ„å˜æ›´
- ç¼ºå°‘ç‰ˆæœ¬ç®¡ç†
- ç´¢å¼•ã€å¤–é”®æ”¯æŒä¸å®Œå–„

**ä¼˜åŒ–å»ºè®®**:
```go
// å®šä¹‰è¿ç§»ç‰ˆæœ¬
type Migration struct {
    Version     int
    Description string
    Up          func(db *DB) error
    Down        func(db *DB) error
}

// è¿ç§»ç®¡ç†å™¨
type Migrator struct {
    db      *DB
    history map[int]bool
}

func (m *Migrator) AddMigration(mig *Migration) {
    // æ·»åŠ è¿ç§»
}

func (m *Migrator) Migrate() error {
    // æ‰§è¡Œå¾…å¤„ç†çš„è¿ç§»
}

// AutoMigrateå¢å¼º
func (db *DB) AutoMigrate(values ...any) error {
    for _, value := range values {
        m, err := model.GetModel(value)
        if err != nil {
            return err
        }

        // 1. æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
        exists, err := db.HasTable(m.TableName)
        if err != nil {
            return err
        }

        // 2. å¦‚æœä¸å­˜åœ¨,åˆ›å»ºè¡¨
        if !exists {
            createSQL, createArgs := db.dialect.CreateTableSQL(m)
            _, err = db.Exec(createSQL, createArgs...)
            if err != nil {
                return err
            }
        } else {
            // 3. å¦‚æœå­˜åœ¨,æ¯”è¾ƒå­—æ®µå·®å¼‚
            if err := db.alterTableIfNeeded(m); err != nil {
                return err
            }
        }

        // 4. åˆ›å»º/æ›´æ–°ç´¢å¼•
        if err := db.syncIndexes(m); err != nil {
            return err
        }
    }
    return nil
}
```

**ä¼˜åŒ–åå¥½å¤„**:
- è‡ªåŠ¨å¤„ç†è¡¨ç»“æ„å˜æ›´
- å‡å°‘æ‰‹åŠ¨ç»´æŠ¤å·¥ä½œ
- æ”¯æŒæ•°æ®åº“ç‰ˆæœ¬æ§åˆ¶
- æ›´å®‰å…¨çš„è¿ç§»æµç¨‹

**é¢„è®¡å·¥ä½œé‡**: 3-4å¤©

---

## ğŸŸ¢ ä½ä¼˜å…ˆçº§ (P2) - ä½“éªŒä¼˜åŒ–

### 11. è½¯åˆ é™¤æ”¯æŒ
**å½“å‰ä½ç½®**: æ— 

**ä¸è¶³ä¹‹å¤„**:
- ç¼ºå°‘å†…ç½®è½¯åˆ é™¤åŠŸèƒ½
- ä¸šåŠ¡é€»è¾‘éœ€è¦æ‰‹åŠ¨å®ç°
- æ— æ³•è¿½æº¯å†å²æ•°æ®

**ä¼˜åŒ–å»ºè®®**:
```go
// è½¯åˆ é™¤æ¨¡å‹
type SoftDeletable struct {
    DeletedAt *time.Time `jorm:"column:deleted_at"`
}

// å…¨å±€è½¯åˆ é™¤é’©å­
type GormDeleter struct {
    db *DB
}

func (g *GormDeleter) BeforeDelete(tx *Tx) error {
    // è®¾ç½®deleted_atè€Œä¸æ˜¯çœŸå®åˆ é™¤
}

// æŸ¥è¯¢æ—¶è‡ªåŠ¨è¿‡æ»¤å·²åˆ é™¤è®°å½•
func (q *Query) Unscoped() *Query {
    // æŸ¥è¯¢åŒ…å«å·²åˆ é™¤è®°å½•
}
```

**ä¼˜åŒ–åå¥½å¤„**:
- æ•°æ®å®‰å…¨ä¿æŠ¤
- æ”¯æŒæ•°æ®æ¢å¤
- å®¡è®¡è¿½è¸ª

**é¢„è®¡å·¥ä½œé‡**: 2å¤©

---

### 12. å¤æ‚æŸ¥è¯¢æ„å»ºå™¨
**å½“å‰ä½ç½®**: ä»…æ”¯æŒç®€å•çš„WHEREæ¡ä»¶

**ä¸è¶³ä¹‹å¤„**:
- ä¸æ”¯æŒåˆ†ç»„(GROUP BY)
- ä¸æ”¯æŒèšåˆå‡½æ•°å°è£…
- ä¸æ”¯æŒå­æŸ¥è¯¢
- WHEREæ¡ä»¶æ„å»ºä¸çµæ´»

**ä¼˜åŒ–å»ºè®®**:
```go
// åˆ†ç»„
func (q *Query) GroupBy(columns ...string) *Query {
    q.builder.GroupBy(columns...)
    return q
}

// Havingæ¡ä»¶
func (q *Query) Having(cond string, args ...any) *Query {
    q.builder.Having(cond, args...)
    return q
}

// å­æŸ¥è¯¢
func (q *Query) Subquery(fn func(*Query)) *Query {
    subQ := q.db.NewQuery()
    fn(subQ)
    // æ„å»ºå­æŸ¥è¯¢SQL
    return q
}

// é“¾å¼WHEREæ¡ä»¶
db.Model(&User{}).
    Where("age > ?", 18).
    And("status = ?", "active").
    Or("role = ?", "admin").
    Find(&users)
```

**ä¼˜åŒ–åå¥½å¤„**:
- æ›´å¼ºå¤§çš„æŸ¥è¯¢èƒ½åŠ›
- ä»£ç æ›´ç®€æ´
- å‡å°‘æ‰‹å†™SQL

**é¢„è®¡å·¥ä½œé‡**: 3-4å¤©

---

### 13. æ€§èƒ½ç›‘æ§å’ŒæŒ‡æ ‡
**å½“å‰ä½ç½®**: ä»…è®°å½•SQLæ‰§è¡Œæ—¶é—´

**ä¸è¶³ä¹‹å¤„**:
- ç¼ºå°‘æ…¢æŸ¥è¯¢æ—¥å¿—
- æ— æŸ¥è¯¢ç»Ÿè®¡
- ä¸æ”¯æŒAPMé›†æˆ

**ä¼˜åŒ–å»ºè®®**:
```go
// æ€§èƒ½ç›‘æ§å™¨
type Metrics struct {
    QueryCount      atomic.Int64
    SlowQueryCount  atomic.Int64
    TotalDuration   atomic.Int64
    ErrorCount      atomic.Int64
}

// æ…¢æŸ¥è¯¢é˜ˆå€¼
type SlowQueryLogger struct {
    threshold time.Duration
    logger    Logger
}

func (s *SlowQueryLogger) Log(sql string, duration time.Duration, args ...any) {
    if duration > s.threshold {
        s.logger.Warn("SLOW QUERY: %v took %v", sql, duration)
    }
}

// é›†æˆOpenTelemetry
func (q *Query) WithTracing(ctx context.Context) *Query {
    span := tracer.Start(ctx, "jorm.query")
    defer span.End()

    // æ‰§è¡ŒæŸ¥è¯¢
    err := q.Find(dest)
    span.RecordError(err)
    return q
}
```

**ä¼˜åŒ–åå¥½å¤„**:
- åŠæ—¶å‘ç°æ€§èƒ½é—®é¢˜
- ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- æ”¯æŒAPMç›‘æ§

**é¢„è®¡å·¥ä½œé‡**: 2å¤©

---

### 14. Builderå¯¹è±¡æ± ä¼˜åŒ–
**å½“å‰ä½ç½®**: `core/builder.go:49-72`

**ä¸è¶³ä¹‹å¤„**:
- å¯¹è±¡æ± é‡ç”¨é€»è¾‘ç®€å•
- å¯èƒ½é€ æˆå†…å­˜å ç”¨
- é«˜å¹¶å‘ä¸‹ç«äº‰æ¿€çƒˆ

**ä¼˜åŒ–å»ºè®®**:
```go
// åˆ†çº§å¯¹è±¡æ± 
type builderPool struct {
    small  sync.Pool  // ç®€å•æŸ¥è¯¢
    medium sync.Pool  // ä¸­ç­‰å¤æ‚åº¦
    large  sync.Pool  // å¤æ‚æŸ¥è¯¢
}

// æ ¹æ®æŸ¥è¯¢å¤æ‚åº¦é€‰æ‹©æ± 
func (p *builderPool) Get(complexity int) *sqlBuilder {
    switch {
    case complexity < 5:
        return p.small.Get().(*sqlBuilder)
    case complexity < 15:
        return p.medium.Get().(*sqlBuilder)
    default:
        return p.large.Get().(*sqlBuilder)
    }
}

// é™åˆ¶å¯¹è±¡æ± å¤§å°
const maxPoolSize = 1000

func (p *builderPool) Put(b *sqlBuilder) {
    if p.currentSize >= maxPoolSize {
        return  // ç›´æ¥ä¸¢å¼ƒ,é¿å…å†…å­˜è†¨èƒ€
    }
    p.currentSize++
    // ...
}
```

**ä¼˜åŒ–åå¥½å¤„**:
- æ›´å¥½çš„å†…å­˜ç®¡ç†
- å‡å°‘GCå‹åŠ›
- ä¼˜åŒ–é«˜å¹¶å‘æ€§èƒ½

**é¢„è®¡å·¥ä½œé‡**: 1å¤©

---

### 15. æ•°æ®åº“æ–¹è¨€æ‰©å±• - æ›´å¤šæ•°æ®åº“
**å½“å‰ä½ç½®**: ä»…æ”¯æŒMySQLã€PostgreSQLã€SQLite

**ä¸è¶³ä¹‹å¤„**:
- ä¸æ”¯æŒSQL Server
- ä¸æ”¯æŒOracle
- ä¸æ”¯æŒTiDBç­‰å›½äº§æ•°æ®åº“

**ä¼˜åŒ–å»ºè®®**:
```go
// SQL Serveræ–¹è¨€
type sqlserver struct{}

func (d *sqlserver) DataTypeOf(typ reflect.Type) string {
    switch typ.Kind() {
    case reflect.Bool:
        return "BIT"
    case reflect.String:
        return "NVARCHAR(255)"
    // ...
    }
}

// Oracleæ–¹è¨€
type oracle struct{}

func (d *oracle) Placeholder(index int) string {
    return fmt.Sprintf(":%d", index)
}

// æ³¨å†Œæ–°æ–¹è¨€
dialect.Register("sqlserver", &sqlserver{})
dialect.Register("oracle", &oracle{})
```

**ä¼˜åŒ–åå¥½å¤„**:
- æ‰©å±•åº”ç”¨åœºæ™¯
- æ”¯æŒæ›´å¤šä¼ä¸šéœ€æ±‚
- æå‡é¡¹ç›®ç«äº‰åŠ›

**é¢„è®¡å·¥ä½œé‡**: æ¯ä¸ªæ•°æ®åº“2-3å¤©

---

### 16. ç±»å‹è½¬æ¢å™¨
**å½“å‰ä½ç½®**: ç¡¬ç¼–ç ç±»å‹è½¬æ¢é€»è¾‘

**ä¸è¶³ä¹‹å¤„**:
- ä¸æ”¯æŒè‡ªå®šä¹‰ç±»å‹
- æ— æ³•å¤„ç†JSONã€æšä¸¾ç­‰ç‰¹æ®Šç±»å‹
- æ‰«æé€»è¾‘ä¸çµæ´»

**ä¼˜åŒ–å»ºè®®**:
```go
// ç±»å‹è½¬æ¢å™¨æ¥å£
type ValueConverter interface {
    ConvertValue(v any) (any, error)
}

type Scanner interface {
    Scan(src any) error
}

type Valuer interface {
    Value() (any, error)
}

// æ³¨å†Œè‡ªå®šä¹‰è½¬æ¢å™¨
type CustomType string

func (c *CustomType) Scan(value any) error {
    // å®ç°æ‰«æé€»è¾‘
}

func (c CustomType) Value() (any, error) {
    // å®ç°å€¼é€»è¾‘
}

// JSONç±»å‹æ”¯æŒ
type JSON struct {
    Data any
}

func (j *JSON) Scan(value any) error {
    bytes, ok := value.([]byte)
    if !ok {
        return fmt.Errorf("failed to unmarshal JSON value")
    }
    return json.Unmarshal(bytes, &j.Data)
}

func (j JSON) Value() (any, error) {
    return json.Marshal(j.Data)
}
```

**ä¼˜åŒ–åå¥½å¤„**:
- æ”¯æŒè‡ªå®šä¹‰æ•°æ®ç±»å‹
- æ›´çµæ´»çš„ç±»å‹æ˜ å°„
- æ”¯æŒå¤æ‚ç±»å‹(JSONã€æšä¸¾ç­‰)

**é¢„è®¡å·¥ä½œé‡**: 2-3å¤©

---

### 17. Preloadä»£ç é‡æ„
**å½“å‰ä½ç½®**: `core/preload.go` (746è¡Œ,è¿‡é•¿)

**ä¸è¶³ä¹‹å¤„**:
- å•æ–‡ä»¶è¿‡é•¿,éš¾ä»¥ç»´æŠ¤
- èŒè´£ä¸æ¸…æ™°
- ç¼ºå°‘å•å…ƒæµ‹è¯•

**ä¼˜åŒ–å»ºè®®**:
```go
// æ‹†åˆ†ä¸ºå¤šä¸ªæ–‡ä»¶
core/preload/
â”œâ”€â”€ executor.go      // é¢„åŠ è½½æ‰§è¡Œå™¨
â”œâ”€â”€ has_relation.go  // HasOne/HasManyé€»è¾‘
â”œâ”€â”€ belongs_to.go    // BelongsToé€»è¾‘
â”œâ”€â”€ many_to_many.go  // ManyToManyé€»è¾‘
â”œâ”€â”€ mapper.go        // ç»“æœæ˜ å°„
â””â”€â”€ helpers.go       // è¾…åŠ©å‡½æ•°

// æˆ–è€…æå–åˆ°ç‹¬ç«‹çš„preloadåŒ…
preload/
â”œâ”€â”€ executor.go
â”œâ”€â”€ strategies.go
â””â”€â”€ mappers.go
```

**ä¼˜åŒ–åå¥½å¤„**:
- ä»£ç ç»“æ„æ¸…æ™°
- æ˜“äºæµ‹è¯•å’Œç»´æŠ¤
- èŒè´£åˆ†ç¦»æ˜ç¡®

**é¢„è®¡å·¥ä½œé‡**: 1å¤©

---

### 18. æŸ¥è¯¢ç¼“å­˜
**å½“å‰ä½ç½®**: æ— 

**ä¸è¶³ä¹‹å¤„**:
- é‡å¤æŸ¥è¯¢æœªç¼“å­˜
- æ€§èƒ½ä¼˜åŒ–ç©ºé—´å¤§

**ä¼˜åŒ–å»ºè®®**:
```go
// æŸ¥è¯¢ç¼“å­˜æ¥å£
type QueryCache interface {
    Get(key string) (any, bool)
    Set(key string, value any, ttl time.Duration)
    Delete(key string)
    Clear()
}

// Redisç¼“å­˜å®ç°
type RedisQueryCache struct {
    client *redis.Client
}

// å†…å­˜ç¼“å­˜å®ç°
type MemoryQueryCache struct {
    store sync.Map
}

// ä½¿ç”¨ç¤ºä¾‹
cache := &MemoryQueryCache{}
db.SetCache(cache)

db.Model(&User{}).
    Where("id = ?", 1).
    Cache(time.Minute).  // ç¼“å­˜1åˆ†é’Ÿ
    First(&user)
```

**ä¼˜åŒ–åå¥½å¤„**:
- å‡å°‘æ•°æ®åº“è´Ÿè½½
- æå‡æŸ¥è¯¢æ€§èƒ½
- æ”¯æŒåˆ†å¸ƒå¼ç¼“å­˜

**é¢„è®¡å·¥ä½œé‡**: 2-3å¤©

---

### 19. æ•°æ®éªŒè¯
**å½“å‰ä½ç½®**: æ— å†…ç½®éªŒè¯

**ä¸è¶³ä¹‹å¤„**:
- ç¼ºå°‘æ•°æ®æ ¡éªŒ
- å¯èƒ½æ’å…¥æ— æ•ˆæ•°æ®
- éœ€è¦æ‰‹åŠ¨å®ç°éªŒè¯é€»è¾‘

**ä¼˜åŒ–å»ºè®®**:
```go
// éªŒè¯å™¨æ¥å£
type Validator interface {
    Validate() error
}

// å†…ç½®éªŒè¯æ ‡ç­¾
type User struct {
    Name  string `jorm:"size:100 notnull;validate:required,min=3,max=50"`
    Email string `jorm:"size:100 unique;validate:email"`
    Age   int    `jorm:"default:0;validate:min=0,max=150"`
}

// éªŒè¯å™¨å®ç°
type DefaultValidator struct{}

func (v *DefaultValidator) Validate(value any) error {
    m, err := model.GetModel(value)
    if err != nil {
        return err
    }

    val := reflect.ValueOf(value)
    for _, field := range m.Fields {
        fVal := val.Field(field.Index)
        if err := v.validateField(field, fVal); err != nil {
            return fmt.Errorf("%s: %w", field.Name, err)
        }
    }
    return nil
}

// é’©å­ä¸­è°ƒç”¨éªŒè¯
func (u *User) BeforeInsert() error {
    return validator.Validate(u)
}
```

**ä¼˜åŒ–åå¥½å¤„**:
- ä¿è¯æ•°æ®å®Œæ•´æ€§
- å‡å°‘æ— æ•ˆæ•°æ®
- æé«˜ä»£ç å¥å£®æ€§

**é¢„è®¡å·¥ä½œé‡**: 2-3å¤©

---

### 20. è¿æ¥æ± é…ç½®å¢å¼º
**å½“å‰ä½ç½®**: `core/db.go:16-20`, é…ç½®é¡¹æœ‰é™

**ä¸è¶³ä¹‹å¤„**:
- ç¼ºå°‘ `ConnMaxIdleTime` é…ç½®
- æ— æ³•é…ç½®è¿æ¥ç”Ÿå‘½å‘¨æœŸç­–ç•¥
- ç¼ºå°‘è¿æ¥å¥åº·æ£€æŸ¥é…ç½®

**ä¼˜åŒ–å»ºè®®**:
```go
// æ‰©å±•Options
type Options struct {
    MaxOpenConns    int
    MaxIdleConns    int
    ConnMaxLifetime time.Duration
    ConnMaxIdleTime time.Duration  // æ–°å¢

    // è¿æ¥å¥åº·æ£€æŸ¥
    ConnHealthCheckInterval time.Duration
    ConnHealthCheckTimeout  time.Duration

    // è¿æ¥æ± ç›‘æ§
    EnableMetrics bool
}

// ä½¿ç”¨ç¤ºä¾‹
opts := &core.Options{
    MaxOpenConns:          100,
    MaxIdleConns:          10,
    ConnMaxLifetime:       time.Hour,
    ConnMaxIdleTime:       time.Minute * 10,  // 10åˆ†é’Ÿç©ºé—²åå…³é—­
    ConnHealthCheckInterval: time.Minute,
    EnableMetrics:         true,
}
```

**ä¼˜åŒ–åå¥½å¤„**:
- æ›´çµæ´»çš„è¿æ¥æ± é…ç½®
- é¿å…è¿æ¥æ³„æ¼
- é€‚åº”ä¸åŒè´Ÿè½½åœºæ™¯

**é¢„è®¡å·¥ä½œé‡**: 1å¤©

---

## ğŸ“Š ä¼˜å…ˆçº§æ€»ç»“

### å¿…é¡»ç«‹å³å¤„ç† (P0)
- **æµ‹è¯•è¦†ç›–ç‡** - è´¨é‡ä¿è¯çš„åŸºç¡€
- **SQLæ³¨å…¥é£é™©** - å®‰å…¨æ€§é—®é¢˜
- **é”™è¯¯å¤„ç†** - è°ƒè¯•å’Œç»´æŠ¤çš„å…³é”®
- **åå°„æ€§èƒ½** - æ ¸å¿ƒæ€§èƒ½ç“¶é¢ˆ
- **å¹¶å‘å®‰å…¨** - æ•°æ®ä¸€è‡´æ€§ä¿è¯

### çŸ­æœŸæ”¹è¿› (P1)
- è¿æ¥æ± ç›‘æ§
- æ‰¹é‡æ’å…¥ä¼˜åŒ–
- ç»“æ„åŒ–æ—¥å¿—
- äº‹åŠ¡éš”ç¦»çº§åˆ«
- AutoMigrateå¢å¼º

### é•¿æœŸè§„åˆ’ (P2)
- è½¯åˆ é™¤æ”¯æŒ
- å¤æ‚æŸ¥è¯¢æ„å»ºå™¨
- æ€§èƒ½ç›‘æ§
- å¯¹è±¡æ± ä¼˜åŒ–
- æ›´å¤šæ•°æ®åº“æ–¹è¨€
- ç±»å‹è½¬æ¢å™¨
- ä»£ç é‡æ„
- æŸ¥è¯¢ç¼“å­˜
- æ•°æ®éªŒè¯
- é…ç½®å¢å¼º

---

## ğŸ¯ å®æ–½å»ºè®®

### ç¬¬ä¸€é˜¶æ®µ (2-3å‘¨)
1. ç¼–å†™æ ¸å¿ƒæ¨¡å—å•å…ƒæµ‹è¯•
2. ä¿®å¤SQLæ³¨å…¥é£é™©
3. æ”¹è¿›é”™è¯¯å¤„ç†

### ç¬¬äºŒé˜¶æ®µ (3-4å‘¨)
1. åå°„æ€§èƒ½ä¼˜åŒ–
2. ä¿®å¤å¹¶å‘å®‰å…¨é—®é¢˜
3. è¿æ¥æ± ç›‘æ§å’ŒæŒ‡æ ‡

### ç¬¬ä¸‰é˜¶æ®µ (4-6å‘¨)
1. æ‰¹é‡æ’å…¥ä¼˜åŒ–
2. ç»“æ„åŒ–æ—¥å¿—
3. AutoMigrateå¢å¼º

### ç¬¬å››é˜¶æ®µ (æŒç»­ä¼˜åŒ–)
1. æ ¹æ®ç”¨æˆ·åé¦ˆé€æ­¥å®ç°P2åŠŸèƒ½
2. æ€§èƒ½è°ƒä¼˜
3. åŠŸèƒ½å®Œå–„

---

## ğŸ“ é¢„è®¡æ€»å·¥ä½œé‡

| ä¼˜å…ˆçº§ | é¡¹ç›®æ•° | é¢„è®¡å·¥ä½œé‡ |
|--------|--------|-----------|
| P0 | 5 | 12-17å¤© |
| P1 | 5 | 9-14å¤© |
| P2 | 15 | 23-30å¤© |
| **æ€»è®¡** | **25** | **44-61å¤©** |

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å‘åå…¼å®¹æ€§**: ä¼˜åŒ–æ—¶éœ€ä¿æŒAPIå‘åå…¼å®¹
2. **æ€§èƒ½æµ‹è¯•**: æ¯æ¬¡æ€§èƒ½ä¼˜åŒ–åéœ€è¿è¡ŒåŸºå‡†æµ‹è¯•
3. **æ–‡æ¡£æ›´æ–°**: ä¼˜åŒ–åéœ€åŒæ­¥æ›´æ–°æ–‡æ¡£å’Œç¤ºä¾‹
4. **ç¤¾åŒºåé¦ˆ**: ä¼˜å…ˆè§£å†³ç”¨æˆ·åé¦ˆçš„é—®é¢˜
5. **æ¸è¿›å¼æ”¹è¿›**: ä¸å¿…ä¸€æ¬¡æ€§å®Œæˆæ‰€æœ‰ä¼˜åŒ–,åˆ†é˜¶æ®µå®æ–½

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [AGENTS.md](./AGENTS.md) - å¼€å‘æŒ‡å—
- [ARCHITECTURE.md](./ARCHITECTURE.md) - æ¶æ„æ–‡æ¡£
- [README.md](./README.md) - ä½¿ç”¨è¯´æ˜
- [USAGE.md](./USAGE.md) - è¯¦ç»†ç”¨æ³•

---

**æ–‡æ¡£ç‰ˆæœ¬**: 2.0
**æœ€åæ›´æ–°**: 2026-01-15
**ç»´æŠ¤è€…**: jormå¼€å‘å›¢é˜Ÿ
